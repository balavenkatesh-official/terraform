pipeline {
    agent any

    parameters {
        string(name: 'Access_key', defaultValue: '', description: 'AWS Access Key')
        string(name: 'Secret_key', defaultValue: '', description: 'AWS Secret Key')
        string(name: 'project_name', defaultValue: '', description: 'Project_name')
        booleanParam(name: 'DESTROY_INFRA', defaultValue: false, description: 'Set to true to destroy the infrastructure')
    }

    stages {
        stage('Prepare Workspace') {
            steps {
                sh 'ls -la'
            }
        }
    

        stage('Generate SSH Key') {
            steps {
                script {
                    def project_name = params.project_name
                    sh """
                        ssh-keygen -t rsa -b 4096 -C "" -N '' -f ${project_name}
                        mv -v ${project_name} ${project_name}.pem
                        chmod -R 400 ${project_name}.pem
                    """
                    def value = sh(script: "cat ${project_name}.pub", returnStdout: true).trim()
                    sh """
                        sed -i "s|PUBLICKEY|${value}|g" terraform/input.tf
                    """
                }
            }
        }

        stage('Replace Variables') {
            steps {
                script {
                    sh """
                        sed -i "s|ACCESSKEY|${params.Access_key}|g" terraform/input.tf
                        sed -i "s|SECRETKEY|${params.Secret_key}|g" terraform/input.tf
                    """
                }
            }
        }

        stage('Terraform Init and Apply') {
            steps {
                dir('terraform') {
                    sh 'terraform init'
                    sh 'terraform apply --auto-approve'
                }
            }
        }

        stage('Save Outputs') {
            steps {
                dir('terraform') {
                    sh 'terraform output > output.txt'
                    sh 'mv -v output.txt ..'
                }
            }
        }  

        stage('Terraform Destroy') {
            when {
                expression { params.DESTROY_INFRA }
            }
            steps {
                dir('terraform') {
                    sh 'terraform destroy --auto-approve'
                }
            }
        }
   }
   post {
        always {
            archiveArtifacts artifacts: 'output.txt', allowEmptyArchive: true
        }
    }

}
